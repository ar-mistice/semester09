% Report on research work for 10th semester in SPbSTU.
% Copyright (C) 2010-2011 Vladimir Rutsky <altsysrq@gmail.com>

\documentclass[a4paper,12pt]{article}

% Encoding support.
\usepackage{ucs}
\usepackage[utf8x]{inputenc}
\usepackage[T2A]{fontenc}
\usepackage[russian,english]{babel}

\usepackage{amsmath, amsthm, amssymb}

% Spaces after commas.
\frenchspacing
% Minimal carrying number of characters,
\righthyphenmin=2

% From K.V.Voroncov Latex in samples, 2005.
%\textheight=24cm   % text height
\textheight=25cm   % text height
\textwidth=16cm    % text width.
\oddsidemargin=0pt % left side indention
\topmargin=-1.5cm  % top side indention.
\parindent=24pt    % paragraph indent
\parskip=0pt       % distance between paragraphs.
\tolerance=2000
%\flushbottom       % page height aligning
%\hoffset=0cm
%\pagestyle{empty}  % without numeration

% Indenting first paragraph.
\usepackage{indentfirst}

\usepackage{setspace}
%\linespread{1.5}

\usepackage{enumitem}
%\usepackage{datetime}
\usepackage{verbatim}
\usepackage{commath}
\usepackage{subfig}
\usepackage{tikz}

% from http://www.latex-community.org/forum/viewtopic.php?f=5&t=1383&start=0&st=0&sk=t&sd=a
\makeatletter
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
  {-3.25ex\@plus -1ex \@minus -.2ex}%
  {1.5ex \@plus .2ex}%
  {\normalfont\normalsize\bfseries}}
\makeatother

\begin{document}
\selectlanguage{russian}

\begin{center}
\begin{spacing}{1.3}
  {\Large\bfseries Отчет по проделанной работе в рамках НИРС} \\
  {\large Руцкий Владимир Владимирович, гр.~5057/12, 10~семестр 2011~г.}
\end{spacing}
\end{center}

\noindent\textbf{Тема работы:}\quad Решение задачи построения ортофотоплана по аэрофотоснимкам с большим параллаксом \\
\textbf{Место выполнения:}\quad ЗАО <<Транзас Новые Технологии>> \\
\textbf{Руководитель:}\quad Ковалёв Антон Сергеевич, 
магистр прикладной математики и информатики, 
ведущий инженер-программист (руководитель группы) ЗАО <<Транзас Новые Технологии>>

\section{Постановка задачи}
Даны два аэрофотоснимка поверхности Земли, сделанных из камеры, установленной на низколетающем летательном аппарате
(высота съёмки над поверхностью Земли находится в диапазоне от 800 до 1600 метров).

Углы зрения камеры лежат в диапазоне от $30^{\circ}$ до $60^{\circ}$.
Направление съёмки отклоняется от вертикального вниз не более чем на несколько градусов.
Снимки получены с высоким пространственным разрешением от 15 до 40~см на точку.

Положения камеры в пространстве в момент съёмки известны с точностью до 50 метров, 
ориентация камер~--- с точностью до $30^{\circ}$.
Снятые камерой области поверхности Земли, пересекаются не менее чем половиной своей площади,
и объекты, стоящие на снимаемой поверхности и снятые на обоих снимках, видны под разными углами.

На снимаемой поверхности Земли встречаются объекты, возвышающиеся над её поверхностью на высоту до 40 метров: 
строения, деревья; 
и объекты, опускающиеся на глубину до нескольких метров: канавы, рвы.
В результате съёмки таких объектов из разных точек возникает явление параллакса:
объекты, не лежащие на поверхности Земли, оказываются смещены относительно объектов, лежащих на поверхности Земли,
на разных снимках на разное расстояние.

Требуется по данным снимкам выбрать точки привязки и построить ортофотоплан.

\section{Элементы исследования и новизны}
Из-за параллакса значительно усложняется задача совмещения снимков. 
Например, при преобладании на снимках леса,
снимки могут быть ошибочно совмещены не по плоскости Земли, 
а по плоскости верхушек деревьев леса, и
тогда снятая на тех же снимках дорога может быть некорректно состыкована на
результирующем изображении.
Особенно эта проблема проявляется на снимках городов.

Данная задача была изучена для съёмок с больших высот и более низкой 
детализацией снимков.

\section{Ожидаемый результат}
Решение поставленной задачи позволит улучшить качество ортофотопланов, 
получаемых из аэрофотоснимков, сделанных на низких высотах. 

\section{Среда разработки}

Платформа: Microsoft Windows XP.

Языки программирования: C++, Python.

Среда разработки: Microsoft Visual Studio, NetBeans.

Используемые библиотеки: OpenCV, FLANN. % TODO

\section{Выполненная работа}

% \subsection{Анализ востребованности решения поставленной задачи}
% Ортофотопланы являются неотъемлемой частью фотограмметрии.
% 
% Для получения ортофотоплана необходимо:
%    1) получить снимки Земли, 
%    2) сшить снимки.
% 
% Bсточники снимков: 
%    1) космическая съёмка, 
%    2) аэрофотосъемка.
%    
% Космическая съёмка: 
%    дорогая, 
%    не оперативная (требует погодных условий и наличия спутника), 
%    ограниченное пространственное разрешение, 
%    с большими ограничениями доступна для коммерческих организаций, 
%    но высокоточная.
% 
% Аэрофотосъемка: 
%    дешевая, 
%    оперативная, 
%    высокое пространственное разрешение, 
%    доступна для небольших организаций. 
% Высокоточные данные возможны только на дорогом и сложном в обращении 
%    оборудовании (\$380K).
% 
% Т.\,о. возникает задача: сшить снимки сделанные с летательного аппарата без 
% точной калибрации и без точной пространственной информации о положении 
% камеры.
% 
\subsection{Обзор литературы}
Поставленная задача относится к области знаний компьютерного зрения, 
основные методы совмещения снимков описаны 
в~\cite{zitova03is-survey, szelisky06alignstichtut, szelisky10compvis}:
\begin{enumerate}
  \item Прямое попиксельное совмещение~\cite{bergen92hmbme}~--- 
  вычислительно сложный подход; 
  при проявлении параллакса на значительной площади метод работает очень плохо;
  точности позиций камер недостаточно для получения корректного
  результата.
  \item Восстановление плотного облака 3D точек~\cite{furu09mvs}~--- очень перспективный, 
  но вычислительно сложный подход.
  \item Восстановление информации о глубине пикселей, рассматривая исходные
  изображения как стереопару~\cite{scharstein02taxonomy}~--- 
  точности исходных данных недостаточно для построения модели эпиполярной 
  геометрии и последующей ректификации изображений.
  \item Совмещение снимков по особенным точкам изображения~\cite{cham98matchframework, brown03recognising, mclauchlan02mosaic}~--- 
  наиболее гибкий подход, на основе которого была решена поставленная задача, 
  описание будет представлено ниже.
\end{enumerate}

%TODO: MPPS (tr-2004-48.pdf)
%NOTE: Методы убирающие параллакс сдвигом - сдвиг не в ту плоскость приведёт
%к построению ортофотоплана со смещённой системой координат относительно 
%реальной.
%NOTE: Снимки из космоса - параллакс незаметен.

%NOTE: Старая аэрофотосъёмка - производятся частые снимки небольшой области строго
%под летательным аппаратом - параллакс незаметен.

\subsection{Выбранный метод решения}

\begin{figure}
  \centering
  \subfloat[Все снимаемые точки лежат в плоскости Земли.]%
{\label{fig:parallax-free-case}
  \begin{tikzpicture}
    \draw[help lines] (0,0) grid (3,2);
    \draw (0,0) coordinate (A) -- (3,2) coordinate (B)
        (1,2) -- (3,0);
    \fill[red] (intersection of A--B and 1,2--3,0) circle (2pt);
  \end{tikzpicture}
}
  \quad
  \subfloat[Не все снимаемые точки лежат в плоскости Земли.]%
{\label{fig:parallax-case}
  \begin{tikzpicture}
    \draw[help lines] (0,0) grid (3,2);
    \draw (0,0) coordinate (A) -- (3,2) coordinate (B)
        (1,2) -- (3,0);
    \fill[red] (intersection of A--B and 1,2--3,0) circle (2pt);
  \end{tikzpicture}
}
  \caption{Съёмка из двух камер.}
  \label{fig:parallax}
\end{figure}

Для построения ортофотоплана был выбран метод, основывающийся на выборе и 
сопоставлении особенных точек изображения~\cite{cham98matchframework, brown03recognising, mclauchlan02mosaic}.
Общая схема алгоритма построения ортофотоплана состоит в следующем:
\begin{enumerate}
  \item На снимках выбираются особенные точки $\cbr{ \mathbf{p}_i }$.
  %\item Каждой особенной точке $\mathbf{p}_i$ ставится в соответствие 
  % дескриптор $\mathbf{v}_i \in \mathbf{R}^n$, 
  %обладающий следующим свойством: 
  %фрагменты снимков, соответствующие особенным точкам 
  % $\mathbf{p}_1$, $\mathbf{p}_2$, тем больше похожи друг на друга, 
  %чем меньше евклидово расстояние в $\mathbf{R}^n$ между их дескрипторами 
  % $d = |\mathbf{v}_1 - \mathbf{v}_2|$.
  
  \item Между снимками ищется множество пар похожих особенных 
  точек $\widetilde{S} = \cbr{(\mathbf{p}_i, \mathbf{p}_j )},$
  где $\mathbf{p}_i$ из первого снимка, а $\mathbf{p}_j$ из второго.
  
  \item По найденным парам похожих особенных точек $\widetilde{S}$ производится 
  оценка матрицы гомографии $\mathbf{H} \in \mathbf{R}_{3, 3}$, 
  задающей преобразование между точками снимков: 
  $\mathbf{p}_1 \approx \mathbf{H} \cdot \mathbf{p}_2$, 
  где $\mathbf{p}_1$ и $\mathbf{p}_2$ точки первого и второго снимков 
  соответственно (в однородных координатах). 
  
  Строится множество пар соответствующих друг-другу особенных точек $S$, путём
  удаления из $\widetilde{S}$ пар точек изображений, явно не связанных
  преобразованием матрицей гомографии $\mathbf{H}$.
  
  В случае отсутствия параллакса, найдённой матрицы гомографии было бы достаточно 
  для построения ортофотоснимка: из матрицы гомографии можно извлечь нормаль 
  плоскости Земли и взаимное положение камер с точностью до масштаба~\cite{malis07homodecomp}, 
  далее изображения можно репроецировать на истинную плоскость Земли.
  
  \item Производится оценка положений камеры в пространстве в момент съёмки
  $\mathbf{c}_1, \mathbf{c}_2 \in \mathbf{R}^3$ и
  положений точек снимаемой поверхности $\cbr{ \mathbf{x}_k } \subset \mathbf{R}^3$,
  соответствующих особенным точкам из $S$, с помощью метода уравнивания
  связок\footnote{англ. \textit{bundle adjustment}}.
  Положения находятся в системе координат связанной с одной из камер.
  
  \item Из $S$ выбираются точки $\Bar{S}$, наиболее вероятно лежащие в 
  плоскости Земли.
  
  \item По $\Bar{S}$ оценивается истинная плоскость поверхности Земли.
  
  \item Изображения репроецируются на найденную плоскость Земли.
  
\end{enumerate}
  
\paragraph{Выбор особенных точек}%
На последовательных снимках, сделанных с летательного аппарата, масштаб 
изображений меняется незначительно, а ориентация камеры может измениться на 
угол до $45^{\circ}$, поэтому оказалось достаточным использовать детектор
особенных точек не инвариантный к масштабу, но инвариантный к повороту.
В качестве такого детектора был реализован модифицированный детектор 
Харриса~\cite{harris88detector}.
% TODO: Здесь можно написать о результатах работы с другими детекторами.

\paragraph{Поиск похожих особенных точек}
Для поиска похожих особенных точек, 
каждой особенной точке $\mathbf{p}_i$ ставится в соответствие 
дескриптор $\mathbf{v}_i \in \mathbf{R}^n$, 
обладающий следующим свойством: 
фрагменты снимков, соответствующие особенным точкам 
$\mathbf{p}_1$, $\mathbf{p}_2$, тем больше похожи друг на друга, 
чем меньше евклидово расстояние в $\mathbf{R}^n$ между их дескрипторами 
$d = |\mathbf{v}_1 - \mathbf{v}_2|$.

Таким образом поиск похожих особенных точек сводится к поиску ближайших 
соседей для точек в пространстве $\mathbf{R}^n$.
Данная задача приближённо решалась с помощью библиотеки FLANN~\cite{muja09flann}.

\paragraph{Оценка матрицы гомографии и фильтрация ошибочных совмещений}
Для оценки матрицы гомографиии и выделения среди множества пар 
соответствующих точек $S$ был реализован алгоритм MLESAC~\cite{torr00mlesac}~---
модификация RANSAC~\cite{fischler81ransac}, 
разработанная специально для оценки матрицы гомографии.

\paragraph{Оценка положений камер и особенных точек}
Для получения оценок положений камер и особенных точек в пространстве был 
использован метод уравнивания связок: формулировалась задача 
минимизации суммы квадратов ошибок репроекции~\cite{szelisky10compvis}, данная задача 
оптимизации решалась алгоритмом 
Левенберга-Марквардта~\cite{levenberg44leastsquares, marquardt63leastsquares}.
% TODO: Здесь можно написать, что были попытки использовать другие способы
% решения bundle adjustment.

\paragraph{Выбор точек на истинной плоскости Земли и оценка плоскости Земли}
Особенные точки в пространстве $\cbr{ \mathbf{x}_k }$ можно разделить на 
следующие категории по распределению высот относительно истинной плоскости 
Земли:
\begin{enumerate}
  \item особенные точки на изображении дорог, земли~--- точки, лежащие на
  плоскости Земли;
  \item особенные точки на изображении леса, растительности~---
  точки, высота которых распределена между нулём и высотой вершин 
  растительности;
  \item особенные точки на изображении крыш зданий~--- точки, лежащие 
  группами в разных плоскостях, параллельных истинной плоскости Земли, выше 
  плоскости Земли;
  \item особенные точки на изображении канав, рек~--- точки, лежащие 
  группами в разных плоскостях, параллельных истинной плоскости Земли, ниже 
  плоскости Земли.
\end{enumerate}

Эффективным способом выделения областей на изображении с точками, 
соответствующими лесу, растительности и точками канав, рек, оказалось 
выделение областей изображения с преобладанием наиболее тёмных пикселей 
исходных изображений.
Наиболее тёмные пиксели исходных изображений выбирались как пиксели имеющие 
яркость из нижнего 0.3-квантиля гистограммы яркости. 

После фильтрации точек, соответствующих лесу и растительности, 
оставшиеся точки соответствовали группам точек, лежащих в 
плоскостях параллельных истинной плоскости Земли, с преобладанием точек, 
лежащих дорогах и земле.
На таких данных истинная плоскость Земли оценивалась с помощью алгоритма 
RANSAC с ограниченным штрафом за точки-выбросы.

%TODO: Feature-detection - инвариантность к масштабу в данной задаче не нужна.
%TODO: Статистический метод для feature совмещения: 
%большой разброс - деревья (т.к. тень).
%TODO: Совмещение по теням
%TODO: Восстановление облака точек.

\subsection{Возникшие проблемы}
\paragraph{Искажение изображения линзами}%
Аберрации оптической системы фотокамеры вносили искажения в исходные снимки 
и приводили к систематическим ошибкам.
Аберрации были аппроксимированы полиномиальной моделью радиального искажения, 
описанной в~\cite{forsythponce04compvis} и~\cite{szelisky10compvis}, 
и убраны обратными преобразованиями.

%TODO: Виньетирование и усреднение яркости.

\section{Результаты}
Был разработан конвейер построения ортофотоплана по паре некалиброванных 
аэрофотоснимков с автоматическим выбором плоскости проектирования. 

Разработанный конвейер был протестирован на реальных данных, в полученных 
ортофотопланах снимки корректно состыкованы по плоскости Земли.

\section{Дальнейшие исследования}
%TODO: Ориентирование на водную поверхность при сшивке.

Вычисления в использованных алгоритмах можно частично перенести на GPU, что 
должно значительно ускорить конечную скорость работы.

Вызванные параллаксом нестыковки на границе между совмещаемыми снимками можно
убрать используя специальные алгоритмы~\cite{shum00mosaic, kang04mpps}.

Построив плотное облако точек и восстановив геометрию 
объектов на поверхности Земли~\cite{furu09mvs}, возможно полностью убрать эффекты 
параллакса и построить геометрически точный ортофотоплан.

\section{Литература}

\begin{thebibliography}{99}

\bibitem{levenberg44leastsquares}
  K.\,Levenberg,
  \emph{A method for the solution of certain problems in least squares}.
  Quarterly of Applied Mathematics, 
  2,
  стр.~164--168.
  1944.

\bibitem{marquardt63leastsquares}
   D.\,W.\,Marquardt,
   \emph{An algorithm for least-squares estimation of nonlinear parameters}.
   Journal of the Society for Industrial and Applied Mathematics,
   11~(2),
   стр.~431--441,
   1963.

\bibitem{fischler81ransac}
  M.\,A.\,Fischler, R.\,C.\,Bolles,
  \emph{Random sample consensus: A paradigm for model fitting with applications to image analysis and automated cartography}.
  Communications of the ACM, 
  24~(6),
  стр.~381--395,
  1981.
 
\bibitem{harris88detector}
  C.\,Harris, M.\,Stephens,
  \emph{A combined corner and edge detector}.
  Proceedings of the 4th Alvey Vision Conference,
  15,
  стр.~147--151,
  1988.

\bibitem{bergen92hmbme}
  J.\,R.\,Bergen, P.\,Anandan, K.\,J.\,Hanna, R.\,Hingorani, 
  \emph{Hierarchical model-based motion estimation}.
  Second European Conference on Computer Vision (ECCV’92), 
  стр.~237--252,
  Springer-Verlag, 
  1992.

\bibitem{cham98matchframework}
  T.\,J.\,Cham, R.\,Cipolla,
  \emph{A Statistical Framework for Long-Range Feature Matching in Uncalibrated Image Mosaicing}.
  Proceedings of the IEEE Computer Society Conference on Computer Vision and Pattern Recognition,
  стр.~442--447,
  1998.

\bibitem{torr00mlesac}
  P.\,H.\,S.\,Torr, A.\,Zisserman,
  \emph{MLESAC: A new robust estimator with application to estimating image geometry}.
  Computer Vision and Image Understanding,
  78~(1),
  стр.~138--156,
  Elsevier,
  2000.
  
\bibitem{shum00mosaic}
  H.\,Y.\,Shum, R.\,Szeliski,
  \emph{Systems and experiment paper: Construction of panoramic image mosaics with global and local alignment}.
  International Journal of Computer Vision,
  36~(2),
  стр.~101--130,
  Springer,
  2000.
  
\bibitem{scharstein02taxonomy}
  D.\,Scharstein, R.\,Szeliski,
  \emph{A taxonomy and evaluation of dense two-frame stereo correspondence algorithms}.
  International journal of computer vision,
  47~(1),
  стр.~7--42,
  Springer,
  2002.

\bibitem{mclauchlan02mosaic}
  P.\,F.\,McLauchlan, A.\,Jaenicke,
  \emph{Image mosaicing using sequential bundle adjustment}.
  Image and Vision Computing,
  20~(9--10),
  стр.~751--759,
  Elsevier,
  2002.

\bibitem{zitova03is-survey}
  B.\,Zitov\'a, J.\,Flusser,
  \emph{Image registration methods: a survey}.
  Image and Vision Computing,
  21,
  стр.~977--1000,
  Elsevier,
  2003.
  
\bibitem{brown03recognising}
  M.\,Brown, D.\,G.\,Lowe,
  \emph{Recognising panoramas},
  Proceedings of the Ninth IEEE International Conference on Computer Vision,
  стр.~1218--1225,
  2003.

\bibitem{forsythponce04compvis}
  Д.\,Форсайт, Ж.\,Понс,
  \emph{Компьютерное зрение. Современный подход}.
  М.: Издательский дом {\guillemotleft}Вильямс{\guillemotright},
  2004.

\bibitem{kang04mpps}
  S.\,B.\,Kang, R.\,Szeliski, M.\,Uyttendaele,
  \emph{Seamless stitching using multi-perspective plane sweep}.
  Microsoft Research,
  2004.

\bibitem{szelisky06alignstichtut}
  R.\,Szeliski,
  \emph{Image Alignment and Stitching: A Tutorial}.
  Now Publishers Inc,
  2006.

\bibitem{malis07homodecomp}
  E.\,Malis, M.\,Vargas,
  \emph{Deeper understanding of the homography decomposition for vision-based control}.
  INRIA,
  2007.

\bibitem{furu09mvs}
  Y.\,Furukawa, J.\,Ponce,
  \emph{Accurate, Dense, and Robust Multi-View Stereopsis}.
  IEEE Trans. on Pattern Analysis and Machine Intelligence,
  2009.
 
\bibitem{muja09flann}
  M.\,Muja, D.\,G.\,Lowe,
  \emph{Fast Approximate Nearest Neighbors with Automatic Algorithm Configuration}.
  International Conference on Computer Vision Theory and Application VISSAPP'09,
  стр.~331--340,
  INSTICC Press,
  2009.

\bibitem{szelisky10compvis}
  R.\,Szeliski,
  \emph{Computer Vision: Algorithms and Applications}.
  Springer,
  2010.

\end{thebibliography}

\begin{comment}
%\begin{flushbottom}
\begin{flushright}
\begin{spacing}{1.5}
\begin{tabular}{l l l}
Студент & \noindent\underline{\makebox[2.5cm][l]{}} & В.\,В.\,Руцкий \\
Руководитель & \noindent\underline{\makebox[2.5cm][l]{}} & А.\,С.\,Ковалёв\\
\end{tabular}
\vspace{1cm}

\today
\end{spacing}
\end{flushright}
%\end{flushbottom}
\end{comment}
\end{document}

% TODO: 
% 1. + раскрыть ссылки на литературу
% 2. + шрифт 12-14
% 3. картинку с параллаксом
% 4. обзор литературы --- вывод
% показать проблематику
% + дана ориентация камер
% указать, что предполагаем, что Земля на снимке плоская
